<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-cache">
<title>CMD Launcher +</title>
<style>
  body { background-color: #000; color: #0f0; font-family: 'Courier New', monospace; padding: 20px; }
  input, button, textarea { background: #111; color: #0f0; border: 1px solid #0f0; font-family: inherit; padding: 5px; margin: 2px; }
  .hidden { display: none; }
  #log { margin-top: 20px; white-space: pre-wrap; }
  textarea { width: 100%; }
</style>
</head>
<body>

<div id="auth">
  <p>> 輸入帳號名稱與 GitHub Token 登入：</p>
  <input type="text" id="username" placeholder="帳號名稱">
  <input type="password" id="token" placeholder="GitHub Token (gist 權限)">
  <button onclick="login()">登入</button>
</div>

<div id="main" class="hidden">
  <p>> 歡迎，<span id="currentUser"></span></p>
  <input type="text" id="command" placeholder="> 輸入指令或網址" onkeydown="if(event.key==='Enter') executeCommand()">
  <button onclick="executeCommand()">執行</button>

  <h3>> 映射設定</h3>
  <input type="text" id="keyInput" placeholder="key">
  <input type="text" id="urlInput" placeholder="URL（可用 %s）">
  <label><input type="checkbox" id="hiddenInput"> 隱藏</label>
  <button onclick="addMapping()">新增</button>

  <h3>> JSON 匯入 / 匯出</h3>
  <button onclick="exportJSON()">匯出 JSON</button>
  <textarea id="importArea" rows="3" placeholder="貼上 JSON 後按匯入"></textarea>
  <button onclick="importJSON()">匯入 JSON</button>

  <pre id="list"></pre>
  <div id="log"></div>
  <button onclick="logout()">登出</button>
</div>

<script>
let mappings = {};
let currentUser = null;
let githubToken = null;
let gistId = null;

function log(msg) {
  const logBox = document.getElementById('log');
  const time = new Date().toLocaleTimeString();
  logBox.textContent += `\n[${time}] ${msg}`;
  logBox.scrollTop = logBox.scrollHeight;
}

async function login() {
  currentUser = document.getElementById('username').value.trim();
  githubToken = document.getElementById('token').value.trim();
  if (!currentUser || !githubToken) return alert('請輸入帳號與 Token');

  document.getElementById('auth').classList.add('hidden');
  document.getElementById('main').classList.remove('hidden');
  document.getElementById('currentUser').textContent = currentUser;

  await loadGist();
  renderList();
  log('登入成功，映射已載入');
}

async function loadGist() {
  try {
    const res = await fetch('https://api.github.com/gists', {
      headers: { 'Authorization': `token ${githubToken}` }
    });
    const gists = await res.json();
    const userGist = gists.find(g => g.description === `cmd_mappings_${currentUser}`);
    if (userGist) {
      gistId = userGist.id;
      const fileName = Object.keys(userGist.files)[0];
      const content = await (await fetch(userGist.files[fileName].raw_url)).text();
      mappings = JSON.parse(content);
      log('已從雲端載入映射');
    } else {
      await saveGist(true);
    }
  } catch (e) {
    log('雲端載入失敗，使用本地或空映射');
    mappings = JSON.parse(localStorage.getItem('cmd_mappings') || '{}');
  }
}

async function saveGist(createNew=false) {
  const payload = {
    description: `cmd_mappings_${currentUser}`,
    public: false,
    files: { [`${currentUser}.json`]: { content: JSON.stringify(mappings, null, 2) } }
  };
  try {
    let url = 'https://api.github.com/gists';
    let method = 'POST';
    if (!createNew && gistId) {
      url = `https://api.github.com/gists/${gistId}`;
      method = 'PATCH';
    }
    const res = await fetch(url, {
      method,
      headers: { 'Authorization': `token ${githubToken}` },
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    gistId = data.id;
    log('☁️ 雲端同步完成');
  } catch(e) {
    log('❌ 雲端同步失敗');
  }
  localStorage.setItem('cmd_mappings', JSON.stringify(mappings));
}

function renderList() {
  const list = document.getElementById('list');
  let output = Object.entries(mappings)
    .filter(([_, v]) => !v.hidden)
    .map(([k, v]) => `${k.padEnd(10)} → ${v.url}`)
    .join('\n');
  list.textContent = output || '(無映射)';
}

function addMapping() {
  const key = document.getElementById('keyInput').value.trim();
  const url = document.getElementById('urlInput').value.trim();
  const hidden = document.getElementById('hiddenInput').checked;
  if (!key || !url) return alert('請輸入完整內容');
  mappings[key] = { url, hidden };
  renderList();
  saveGist();
}

function executeCommand() {
  const input = document.getElementById('command').value.trim();
  if (!input) return;
  const keys = Object.keys(mappings);
  const match = keys.sort((a,b)=>b.length-a.length).find(k => input.startsWith(k));
  if (match) {
    const entry = mappings[match];
    const arg = input.slice(match.length).trim();
    let url = entry.url.includes('%s') ? entry.url.replace('%s', encodeURIComponent(arg)) : entry.url;
    if (!/^https?:\/\//.test(url)) url = 'https://' + url;
    window.open(url, '_blank');
    log(`開啟：${url}`);
  } else if (/^https?:\/\//.test(input) || input.includes('.')) {
    window.open(input.startsWith('http') ? input : 'https://' + input, '_blank');
    log(`直接開啟：${input}`);
  } else {
    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(input)}`;
    window.open(searchUrl, '_blank');
    log(`搜尋：${input}`);
  }
  document.getElementById('command').value = '';
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(mappings, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `${currentUser}_mappings.json`;
  a.click();
}

function importJSON() {
  try {
    const obj = JSON.parse(document.getElementById('importArea').value);
    mappings = obj;
    renderList();
    saveGist();
    log('✅ JSON 匯入成功並同步雲端');
  } catch(e) {
    alert('JSON 格式錯誤');
  }
}

function logout() {
  currentUser = null;
  githubToken = null;
  gistId = null;
  mappings = {};
  document.getElementById('auth').classList.remove('hidden');
  document.getElementById('main').classList.add('hidden');
  log('已登出');
}
</script>
</body>
</html>
